---
import { getCollection, getEntry } from "astro:content";
import SocialIcon from "~/components/ui/social-icon.astro";
import ArticleCard from "~/components/sections/articles/components/article-card.svelte";
import Layout from "~/layouts/Layout.astro";
import ScrollProgress from "~/components/sections/articles/components/scroll-progress.svelte";
import ScrollToTop from "~/components/sections/articles/components/scroll-to-top.svelte";
import { t, language } from "~/i18n";
import { getLocalizedPath } from "~/utils/i18n";

const tr = t(Astro.currentLocale as keyof typeof language);
const currentLocale = Astro.currentLocale || "en";

const { slug } = Astro.params;
if (!slug) throw new Error("Slug is required");

const entry = await getEntry("articles", slug);
if (!entry) return Astro.redirect("/404");

const { Content } = await entry.render();

const humanisedPostedDate = new Date(entry.data.date).toLocaleDateString(
  currentLocale === "id" ? "id-ID" : "en-US",
  { year: "numeric", month: "long", day: "numeric" }
);

const timeToReadInMinutes = Math.ceil(entry.body.split(" ").length / 200);

const articles = await getCollection("articles");
const sortedArticlesMeta = articles
  .sort((a, b) => b.data.date.getTime() - a.data.date.getTime())
  .filter((a) => a.slug !== slug);

const seoTitle = entry.data.title;
const seoDescription =
  entry.data.description ||
  entry.body.slice(0, 160).replace(/\n/g, " ");

const seoImage = entry.data.image;
const canonical = Astro.url.href;

export async function getStaticPaths() {
  const entries = await getCollection("articles");
  return entries.map((entry) => ({ params: { slug: entry.slug } }));
}
---

<Layout
  title={seoTitle}
  description={seoDescription}
  image={seoImage}
  canonical={canonical}
  type="article"
>
    <ScrollProgress client:load />
    <ScrollToTop client:load />
    <div class="w-full max-w-4xl mx-auto px-4 pt-24 md:pt-32 pb-20">
        <!-- Breadcrumbs -->
        <div class="flex items-center gap-2 text-wri-gray-500 text-sm mb-8">
            <a href={getLocalizedPath("/", currentLocale)} class="hover:text-wri-text transition-colors">{tr.articleDetails.home}</a>
            <span>/</span>
            <a href={getLocalizedPath("/articles", currentLocale)} class="hover:text-wri-text transition-colors">{tr.articleDetails.articles}</a>
            <span>/</span>
            <span class="text-wri-text truncate max-w-[200px]">{entry.data.title}</span>
        </div>

        <!-- Hero Image -->
        <div class="w-full h-64 md:h-[32rem] rounded-2xl overflow-hidden mb-10 shadow-lg">
            <img
                src={entry.data.image}
                alt={entry.data.title}
                class="w-full h-full object-cover"
            />
        </div>

        <!-- Header -->
        <div class="flex flex-col gap-6 mb-12">

            <h1 class="text-4xl md:text-6xl font-serif italic text-wri-text leading-tight text-center">
                {entry.data.title}
            </h1>

            <div class="flex flex-col md:flex-row items-center justify-center gap-4 md:gap-8 border-y border-wri-gray-200 py-6 mt-4 text-wri-gray-600">
                <div class="flex items-center gap-3">
                    <span class="font-medium text-wri-text text-lg">{entry.data.author}</span>
                    <div class="flex gap-2 text-wri-gray-500">
                        {entry.data.github && (
                            <SocialIcon platform="github" url={entry.data.github} />
                        )}
                        {entry.data.linkedin && (
                            <SocialIcon platform="linkedin" url={entry.data.linkedin} />
                        )}
                    </div>
                </div>
                <div class="hidden md:block w-1.5 h-1.5 rounded-full bg-wri-gray-300"></div>
                <div class="flex items-center gap-4 text-base">
                    <span>{humanisedPostedDate}</span>
                    <span class="text-wri-gray-300">&bull;</span>
                    <span>{timeToReadInMinutes} {tr.articleDetails.minRead}</span>
                </div>
            </div>
        </div>



        <!-- Content -->
        <article class="prose md:prose-lg max-w-none
            prose-headings:font-serif prose-headings:italic prose-headings:font-normal prose-headings:text-wri-text
            prose-p:text-wri-gray-600 prose-p:leading-relaxed
            prose-a:text-wri-blue prose-a:no-underline hover:prose-a:underline
            prose-strong:text-wri-text prose-strong:font-medium
            prose-code:text-wri-blue prose-code:bg-wri-blue/5 prose-code:px-1 prose-code:py-0.5 prose-code:rounded prose-code:before:content-none prose-code:after:content-none
            prose-pre:bg-wri-gray-900 prose-pre:text-wri-gray-50
            prose-blockquote:border-l-wri-blue prose-blockquote:text-wri-gray-600 prose-blockquote:bg-wri-gray-50 prose-blockquote:py-2 prose-blockquote:px-4 prose-blockquote:rounded-r-lg
            prose-img:rounded-xl prose-img:shadow-md
            prose-li:text-wri-gray-600
            mb-24">
            <Content />
        </article>

        <!-- Tags -->
        <div class="flex flex-wrap gap-2 mb-16">
            {entry.data.tags.map((tag) => (
                <a 
                    href={`${getLocalizedPath("/articles", currentLocale)}#query=${tag}`}
                    class="bg-wri-gray-100 hover:bg-wri-gray-200 transition-colors rounded-full px-4 py-1.5 text-wri-gray-700 capitalize text-sm font-medium"
                >
                    {tag.replace(/-/g, " ")}
                </a>
            ))}
        </div>

        <!-- Related Articles -->
        {sortedArticlesMeta.length > 0 && (
            <div class="border-t border-wri-gray-200 pt-16">
                <h2 class="text-3xl font-serif italic text-wri-text mb-8">{tr.articleDetails.relatedArticles}</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    {sortedArticlesMeta.slice(0, 2).map((article) => (
                        <ArticleCard
                            title={article.data.title}
                            description={article.data.description}
                            slug={article.slug}
                            date={new Date(article.data.date).toLocaleDateString(currentLocale === "id" ? "id-ID" : "en-US", {
                                year: "numeric",
                                month: "long",
                                day: "numeric",
                            })}
                            image={article.data.image}
                            author={article.data.author}
                            tr={tr}
                            locale={currentLocale}
                        />
                    ))}
                </div>
            </div>
        )}
    </div>
</Layout>
