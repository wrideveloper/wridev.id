---
import { Icon } from "astro-icon/components";

interface GithubContribution {
  date: string;
  count: number;
  level: number;
}

interface GithubMetrics {
  available: boolean;
  contributions: GithubContribution[];
}

interface TalentWithMetrics {
  contacts: { type: string; url: string }[];
  metrics?: {
    github?: GithubMetrics | null;
  };
}

interface Props {
  talent_data: TalentWithMetrics;
}

const { talent_data } = Astro.props;

const githubContact = talent_data.contacts.find(c => c.type === 'github');
const githubUrl = githubContact?.url;

const username = githubUrl 
  ? new URL(githubUrl).pathname.split('/').filter(Boolean).pop() 
  : null;

const githubMetrics = talent_data.metrics?.github;
const isAvailable = githubMetrics?.available && Array.isArray(githubMetrics.contributions);

const getColor = (level: number) => {
    switch(level) {
        case 0: return '#ebedf0';
        case 1: return '#9be9a8';
        case 2: return '#40c463';
        case 3: return '#30a14e';
        case 4: return '#216e39';
        default: return '#ebedf0';
    }
};
---

{username && (
  <div class="w-full bg-white p-6 rounded-3xl border border-wri-gray-200 flex flex-col sm:flex-row items-center gap-8 shadow-sm">
    
    <div class="flex flex-col items-center sm:items-start gap-4 shrink-0 min-w-30">
      <a href={githubUrl}>      
        <div class="p-3 bg-black rounded-2xl inline-block">
          <Icon name="ph:github-logo-fill" class="w-8 h-8 text-white" />
        </div>
      </a>

      <div class="text-center sm:text-left">
          <div class="font-bold text-lg leading-tight">
              {username}
              <br/><span class="font-normal text-wri-gray-500 text-sm">GitHub</span>
          </div>
      </div>
      <a 
        href={githubUrl} 
        target="_blank"
        class="mt-1 px-6 py-2 bg-wri-white border border-wri-gray-200 rounded-lg text-sm font-medium text-wri-gray-700 hover:bg-wri-gray-100 transition-colors"      
      >
        Follow
      </a>
    </div>

    <div class="flex-1 overflow-hidden flex items-center justify-center sm:justify-end w-full">
      {isAvailable && githubMetrics ? ( 
        <div class="grid grid-rows-7 grid-flow-col gap-0.75 opacity-90 overflow-x-auto no-scrollbar mask-gradient">
          {githubMetrics.contributions.slice(-(18 * 7)).map((day) => (
             <div 
               class="w-3 h-3 rounded-xs" 
               style={`background-color: ${getColor(day.level)};`}
               title={`${day.count} contributions on ${day.date}`}
             ></div>
          ))}
        </div>
      ) : (
         <div class="text-sm text-wri-gray-400 italic">
            Stats not available
         </div>
      )}
    </div>
  </div>
)}
