---
import { Icon } from "astro-icon/components";
import type { Talent } from "~/models/talent";

interface Props {
  talent: Talent;
}

const { talent } = Astro.props;

const githubContact = talent.contacts.find(c => c.type === 'github');
const githubUrl = githubContact?.url;

// Extract Username safely (handles trailing slashes too)
// "https://github.com/4RSIM3R" -> "4RSIM3R"
const username = githubUrl 
  ? new URL(githubUrl).pathname.split('/').filter(Boolean).pop() 
  : null;

// Helper for Colors
const getColor = (level: number) => {
    switch(level) {
        case 0: return '#ebedf0';
        case 1: return '#9be9a8';
        case 2: return '#40c463';
        case 3: return '#30a14e';
        case 4: return '#216e39';
        default: return '#ebedf0';
    }
};

// Server-side Fetch
let contributionData = null;
let error = false;

if (username) {
  try {
    const response = await fetch(`https://github-contributions-api.jogruber.de/v4/${username}?y=last`);
    if (response.ok) {
      contributionData = await response.json();
    } else {
      error = true;
    }
  } catch (e) {
    error = true;
  }
}
---

{username && (
  <div class="w-full bg-white p-6 rounded-3xl border border-wri-gray-200 flex flex-col sm:flex-row items-center gap-8 shadow-sm">
    
    <div class="flex flex-col items-center sm:items-start gap-4 shrink-0 min-w-[120px]">
      <div class="p-3 bg-black rounded-2xl inline-block">
          <Icon name="ph:github-logo-fill" class="w-8 h-8 text-white" />
      </div>
      <div class="text-center sm:text-left">
          <div class="font-bold text-lg leading-tight">
              {username}
              <br/><span class="font-normal text-wri-gray-500 text-sm">GitHub</span>
          </div>
      </div>
      <a 
        href={githubUrl} 
        target="_blank"
        class="mt-1 px-6 py-2 bg-wri-white border border-wri-gray-200 rounded-lg text-sm font-medium text-wri-gray-700 hover:bg-wri-gray-100 transition-colors"
      >
        Follow
      </a>
    </div>

    <div class="flex-1 overflow-hidden flex items-center justify-center sm:justify-end w-full">
      {error ? (
         <div class="text-sm text-red-400">Unable to load stats</div>
      ) : contributionData ? (
        <div class="grid grid-rows-7 grid-flow-col gap-[3px] opacity-90 overflow-x-auto no-scrollbar mask-gradient">
          {contributionData.contributions.slice(-(18 * 7)).map((day: any) => (
             <div 
               class="w-3 h-3 rounded-xs" 
               style={`background-color: ${getColor(day.level)};`}
               title={`${day.count} contributions on ${day.date}`}
             ></div>
          ))}
        </div>
      ) : (
         <div class="text-sm text-wri-gray-400">Loading...</div>
      )}
    </div>
  </div>
)}
